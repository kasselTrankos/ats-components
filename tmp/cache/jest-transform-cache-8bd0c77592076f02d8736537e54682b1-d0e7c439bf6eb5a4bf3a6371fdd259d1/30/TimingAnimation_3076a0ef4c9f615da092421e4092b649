a161e3d1620253f36ab82c254223ba57
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var AnimatedValue = require('../nodes/AnimatedValue');

var AnimatedValueXY = require('../nodes/AnimatedValueXY');

var Animation = require('./Animation');

var _require = require('../NativeAnimatedHelper'),
    shouldUseNativeDriver = _require.shouldUseNativeDriver;

var _easeInOut;

function easeInOut() {
  if (!_easeInOut) {
    var Easing = require('../Easing');

    _easeInOut = Easing.inOut(Easing.ease);
  }

  return _easeInOut;
}

var TimingAnimation = function (_Animation) {
  (0, _inherits2["default"])(TimingAnimation, _Animation);

  function TimingAnimation(config) {
    var _config$easing, _config$duration, _config$delay, _config$iterations, _config$isInteraction;

    var _this;

    (0, _classCallCheck2["default"])(this, TimingAnimation);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(TimingAnimation).call(this));
    _this._startTime = void 0;
    _this._fromValue = void 0;
    _this._toValue = void 0;
    _this._duration = void 0;
    _this._delay = void 0;
    _this._easing = void 0;
    _this._onUpdate = void 0;
    _this._animationFrame = void 0;
    _this._timeout = void 0;
    _this._useNativeDriver = void 0;
    _this._toValue = config.toValue;
    _this._easing = (_config$easing = config.easing) != null ? _config$easing : easeInOut();
    _this._duration = (_config$duration = config.duration) != null ? _config$duration : 500;
    _this._delay = (_config$delay = config.delay) != null ? _config$delay : 0;
    _this.__iterations = (_config$iterations = config.iterations) != null ? _config$iterations : 1;
    _this._useNativeDriver = shouldUseNativeDriver(config);
    _this.__isInteraction = (_config$isInteraction = config.isInteraction) != null ? _config$isInteraction : !_this._useNativeDriver;
    return _this;
  }

  (0, _createClass2["default"])(TimingAnimation, [{
    key: "__getNativeAnimationConfig",
    value: function __getNativeAnimationConfig() {
      var frameDuration = 1000.0 / 60.0;
      var frames = [];

      for (var dt = 0.0; dt < this._duration; dt += frameDuration) {
        frames.push(this._easing(dt / this._duration));
      }

      frames.push(this._easing(1));
      return {
        type: 'frames',
        frames: frames,
        toValue: this._toValue,
        iterations: this.__iterations
      };
    }
  }, {
    key: "start",
    value: function start(fromValue, onUpdate, onEnd, previousAnimation, animatedValue) {
      var _this2 = this;

      this.__active = true;
      this._fromValue = fromValue;
      this._onUpdate = onUpdate;
      this.__onEnd = onEnd;

      var start = function start() {
        if (_this2._duration === 0 && !_this2._useNativeDriver) {
          _this2._onUpdate(_this2._toValue);

          _this2.__debouncedOnEnd({
            finished: true
          });
        } else {
          _this2._startTime = Date.now();

          if (_this2._useNativeDriver) {
            _this2.__startNativeAnimation(animatedValue);
          } else {
            _this2._animationFrame = requestAnimationFrame(_this2.onUpdate.bind(_this2));
          }
        }
      };

      if (this._delay) {
        this._timeout = setTimeout(start, this._delay);
      } else {
        start();
      }
    }
  }, {
    key: "onUpdate",
    value: function onUpdate() {
      var now = Date.now();

      if (now >= this._startTime + this._duration) {
        if (this._duration === 0) {
          this._onUpdate(this._toValue);
        } else {
          this._onUpdate(this._fromValue + this._easing(1) * (this._toValue - this._fromValue));
        }

        this.__debouncedOnEnd({
          finished: true
        });

        return;
      }

      this._onUpdate(this._fromValue + this._easing((now - this._startTime) / this._duration) * (this._toValue - this._fromValue));

      if (this.__active) {
        this._animationFrame = requestAnimationFrame(this.onUpdate.bind(this));
      }
    }
  }, {
    key: "stop",
    value: function stop() {
      (0, _get2["default"])((0, _getPrototypeOf2["default"])(TimingAnimation.prototype), "stop", this).call(this);
      this.__active = false;
      clearTimeout(this._timeout);
      global.cancelAnimationFrame(this._animationFrame);

      this.__debouncedOnEnd({
        finished: false
      });
    }
  }]);
  return TimingAnimation;
}(Animation);

module.exports = TimingAnimation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRpbWluZ0FuaW1hdGlvbi5qcyJdLCJuYW1lcyI6WyJBbmltYXRlZFZhbHVlIiwicmVxdWlyZSIsIkFuaW1hdGVkVmFsdWVYWSIsIkFuaW1hdGlvbiIsInNob3VsZFVzZU5hdGl2ZURyaXZlciIsIl9lYXNlSW5PdXQiLCJlYXNlSW5PdXQiLCJFYXNpbmciLCJpbk91dCIsImVhc2UiLCJUaW1pbmdBbmltYXRpb24iLCJjb25maWciLCJfc3RhcnRUaW1lIiwiX2Zyb21WYWx1ZSIsIl90b1ZhbHVlIiwiX2R1cmF0aW9uIiwiX2RlbGF5IiwiX2Vhc2luZyIsIl9vblVwZGF0ZSIsIl9hbmltYXRpb25GcmFtZSIsIl90aW1lb3V0IiwiX3VzZU5hdGl2ZURyaXZlciIsInRvVmFsdWUiLCJlYXNpbmciLCJkdXJhdGlvbiIsImRlbGF5IiwiX19pdGVyYXRpb25zIiwiaXRlcmF0aW9ucyIsIl9faXNJbnRlcmFjdGlvbiIsImlzSW50ZXJhY3Rpb24iLCJmcmFtZUR1cmF0aW9uIiwiZnJhbWVzIiwiZHQiLCJwdXNoIiwidHlwZSIsImZyb21WYWx1ZSIsIm9uVXBkYXRlIiwib25FbmQiLCJwcmV2aW91c0FuaW1hdGlvbiIsImFuaW1hdGVkVmFsdWUiLCJfX2FjdGl2ZSIsIl9fb25FbmQiLCJzdGFydCIsIl9fZGVib3VuY2VkT25FbmQiLCJmaW5pc2hlZCIsIkRhdGUiLCJub3ciLCJfX3N0YXJ0TmF0aXZlQW5pbWF0aW9uIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiYmluZCIsInNldFRpbWVvdXQiLCJjbGVhclRpbWVvdXQiLCJnbG9iYWwiLCJjYW5jZWxBbmltYXRpb25GcmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsYUFBYSxHQUFHQyxPQUFPLENBQUMsd0JBQUQsQ0FBN0I7O0FBQ0EsSUFBTUMsZUFBZSxHQUFHRCxPQUFPLENBQUMsMEJBQUQsQ0FBL0I7O0FBQ0EsSUFBTUUsU0FBUyxHQUFH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VUFBSSxLQUFLMkIsUUFBVCxFQUFtQjtBQUNqQixhQUFLckIsZUFBTCxHQUF1QjZCLHFCQUFxQixDQUFDLEtBQUtaLFFBQUwsQ0FBY2EsSUFBZCxDQUFtQixJQUFuQixDQUFELENBQTVDO0FBQ0Q7QUFDRjs7OzJCQUVZO0FBQ1g7QUFDQSxXQUFLVCxRQUFMLEdBQWdCLEtBQWhCO0FBQ0FXLE1BQUFBLFlBQVksQ0FBQyxLQUFLL0IsUUFBTixDQUFaO0FBQ0FnQyxNQUFBQSxNQUFNLENBQUNDLG9CQUFQLENBQTRCLEtBQUtsQyxlQUFqQzs7QUFDQSxXQUFLd0IsZ0JBQUwsQ0FBc0I7QUFBQ0MsUUFBQUEsUUFBUSxFQUFFO0FBQVgsT0FBdEI7QUFDRDs7O0VBekcyQnpDLFM7O0FBNEc5Qm1ELE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjdDLGVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEFuaW1hdGVkVmFsdWUgPSByZXF1aXJlKCcuLi9ub2Rlcy9BbmltYXRlZFZhbHVlJyk7XG5jb25zdCBBbmltYXRlZFZhbHVlWFkgPSByZXF1aXJlKCcuLi9ub2Rlcy9BbmltYXRlZFZhbHVlWFknKTtcbmNvbnN0IEFuaW1hdGlvbiA9IHJlcXVpcmUoJy4vQW5pbWF0aW9uJyk7XG5cbmNvbnN0IHtzaG91bGRVc2VOYXRpdmVEcml2ZXJ9ID0gcmVxdWlyZSgnLi4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTtcblxuaW1wb3J0IHR5cGUge0FuaW1hdGlvbkNvbmZpZywgRW5kQ2FsbGJhY2t9IGZyb20gJy4vQW5pbWF0aW9uJztcblxuZXhwb3J0IHR5cGUgVGltaW5nQW5pbWF0aW9uQ29uZmlnID0gQW5pbWF0aW9uQ29uZmlnICYge1xuICB0b1ZhbHVlOiBudW1iZXIgfCBBbmltYXRlZFZhbHVlIHwge3g6IG51bWJlciwgeTogbnVtYmVyfSB8IEFuaW1hdGVkVmFsdWVYWSxcbiAgZWFzaW5nPzogKHZhbHVlOiBudW1iZXIpID0+IG51bWJlcixcbiAgZHVyYXRpb24/OiBudW1iZXIsXG4gIGRlbGF5PzogbnVtYmVyLFxufTtcblxuZXhwb3J0IHR5cGUgVGltaW5nQW5pbWF0aW9uQ29uZmlnU2luZ2xlID0gQW5pbWF0aW9uQ29uZmlnICYge1xuICB0b1ZhbHVlOiBudW1iZXIgfCBBbmltYXRlZFZhbHVlLFxuICBlYXNpbmc/OiAodmFsdWU6IG51bWJlcikgPT4gbnVtYmVyLFxuICBkdXJhdGlvbj86IG51bWJlcixcbiAgZGVsYXk/OiBudW1iZXIsXG59O1xuXG5sZXQgX2Vhc2VJbk91dDtcbmZ1bmN0aW9uIGVhc2VJbk91dCgpIHtcbiAgaWYgKCFfZWFzZUluT3V0KSB7XG4gICAgY29uc3QgRWFzaW5nID0gcmVxdWlyZSgnLi4vRWFzaW5nJyk7XG4gICAgX2Vhc2VJbk91dCA9IEVhc2luZy5pbk91dChFYXNpbmcuZWFzZSk7XG4gIH1cbiAgcmV0dXJuIF9lYXNlSW5PdXQ7XG59XG5cbmNsYXNzIFRpbWluZ0FuaW1hdGlvbiBleHRlbmRzIEFuaW1hdGlvbiB7XG4gIF9zdGFydFRpbWU6IG51bWJlcjtcbiAgX2Zyb21WYWx1ZTogbnVtYmVyO1xuICBfdG9WYWx1ZTogYW55O1xuICBfZHVyYXRpb246IG51bWJlcjtcbiAgX2RlbGF5OiBudW1iZXI7XG4gIF9lYXNpbmc6ICh2YWx1ZTogbnVtYmVyKSA9PiBudW1iZXI7XG4gIF9vblVwZGF0ZTogKHZhbHVlOiBudW1iZXIpID0+IHZvaWQ7XG4gIF9hbmltYXRpb25GcmFtZTogYW55O1xuICBfdGltZW91dDogYW55O1xuICBfdXNlTmF0aXZlRHJpdmVyOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogVGltaW5nQW5pbWF0aW9uQ29uZmlnU2luZ2xlKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl90b1ZhbHVlID0gY29uZmlnLnRvVmFsdWU7XG4gICAgdGhpcy5fZWFzaW5nID0gY29uZmlnLmVhc2luZyA/PyBlYXNlSW5PdXQoKTtcbiAgICB0aGlzLl9kdXJhdGlvbiA9IGNvbmZpZy5kdXJhdGlvbiA/PyA1MDA7XG4gICAgdGhpcy5fZGVsYXkgPSBjb25maWcuZGVsYXkgPz8gMDtcbiAgICB0aGlzLl9faXRlcmF0aW9ucyA9IGNvbmZpZy5pdGVyYXRpb25zID8/IDE7XG4gICAgdGhpcy5fdXNlTmF0aXZlRHJpdmVyID0gc2hvdWxkVXNlTmF0aXZlRHJpdmVyKGNvbmZpZyk7XG4gICAgdGhpcy5fX2lzSW50ZXJhY3Rpb24gPSBjb25maWcuaXNJbnRlcmFjdGlvbiA/PyAhdGhpcy5fdXNlTmF0aXZlRHJpdmVyO1xuICB9XG5cbiAgX19nZXROYXRpdmVBbmltYXRpb25Db25maWcoKTogYW55IHtcbiAgICBjb25zdCBmcmFtZUR1cmF0aW9uID0gMTAwMC4wIC8gNjAuMDtcbiAgICBjb25zdCBmcmFtZXMgPSBbXTtcbiAgICBmb3IgKGxldCBkdCA9IDAuMDsgZHQgPCB0aGlzLl9kdXJhdGlvbjsgZHQgKz0gZnJhbWVEdXJhdGlvbikge1xuICAgICAgZnJhbWVzLnB1c2godGhpcy5fZWFzaW5nKGR0IC8gdGhpcy5fZHVyYXRpb24pKTtcbiAgICB9XG4gICAgZnJhbWVzLnB1c2godGhpcy5fZWFzaW5nKDEpKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ2ZyYW1lcycsXG4gICAgICBmcmFtZXMsXG4gICAgICB0b1ZhbHVlOiB0aGlzLl90b1ZhbHVlLFxuICAgICAgaXRlcmF0aW9uczogdGhpcy5fX2l0ZXJhdGlvbnMsXG4gICAgfTtcbiAgfVxuXG4gIHN0YXJ0KFxuICAgIGZyb21WYWx1ZTogbnVtYmVyLFxuICAgIG9uVXBkYXRlOiAodmFsdWU6IG51bWJlcikgPT4gdm9pZCxcbiAgICBvbkVuZDogP0VuZENhbGxiYWNrLFxuICAgIHByZXZpb3VzQW5pbWF0aW9uOiA/QW5pbWF0aW9uLFxuICAgIGFuaW1hdGVkVmFsdWU6IEFuaW1hdGVkVmFsdWUsXG4gICk6IHZvaWQge1xuICAgIHRoaXMuX19hY3RpdmUgPSB0cnVlO1xuICAgIHRoaXMuX2Zyb21WYWx1ZSA9IGZyb21WYWx1ZTtcbiAgICB0aGlzLl9vblVwZGF0ZSA9IG9uVXBkYXRlO1xuICAgIHRoaXMuX19vbkVuZCA9IG9uRW5kO1xuXG4gICAgY29uc3Qgc3RhcnQgPSAoKSA9PiB7XG4gICAgICAvLyBBbmltYXRpb25zIHRoYXQgc29tZXRpbWVzIGhhdmUgMCBkdXJhdGlvbiBhbmQgc29tZXRpbWVzIGRvIG5vdFxuICAgICAgLy8gc3RpbGwgbmVlZCB0byB1c2UgdGhlIG5hdGl2ZSBkcml2ZXIgd2hlbiBkdXJhdGlvbiBpcyAwIHNvIGFzIHRvXG4gICAgICAvLyBub3QgY2F1c2UgaW50ZXJtaXhlZCBKUyBhbmQgbmF0aXZlIGFuaW1hdGlvbnMuXG4gICAgICBpZiAodGhpcy5fZHVyYXRpb24gPT09IDAgJiYgIXRoaXMuX3VzZU5hdGl2ZURyaXZlcikge1xuICAgICAgICB0aGlzLl9vblVwZGF0ZSh0aGlzLl90b1ZhbHVlKTtcbiAgICAgICAgdGhpcy5fX2RlYm91bmNlZE9uRW5kKHtmaW5pc2hlZDogdHJ1ZX0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgaWYgKHRoaXMuX3VzZU5hdGl2ZURyaXZlcikge1xuICAgICAgICAgIHRoaXMuX19zdGFydE5hdGl2ZUFuaW1hdGlvbihhbmltYXRlZFZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShcbiAgICAgICAgICAgIHRoaXMub25VcGRhdGUuYmluZCh0aGlzKSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICBpZiAodGhpcy5fZGVsYXkpIHtcbiAgICAgIHRoaXMuX3RpbWVvdXQgPSBzZXRUaW1lb3V0KHN0YXJ0LCB0aGlzLl9kZWxheSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXJ0KCk7XG4gICAgfVxuICB9XG5cbiAgb25VcGRhdGUoKTogdm9pZCB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBpZiAobm93ID49IHRoaXMuX3N0YXJ0VGltZSArIHRoaXMuX2R1cmF0aW9uKSB7XG4gICAgICBpZiAodGhpcy5fZHVyYXRpb24gPT09IDApIHtcbiAgICAgICAgdGhpcy5fb25VcGRhdGUodGhpcy5fdG9WYWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9vblVwZGF0ZShcbiAgICAgICAgICB0aGlzLl9mcm9tVmFsdWUgKyB0aGlzLl9lYXNpbmcoMSkgKiAodGhpcy5fdG9WYWx1ZSAtIHRoaXMuX2Zyb21WYWx1ZSksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aGlzLl9fZGVib3VuY2VkT25FbmQoe2ZpbmlzaGVkOiB0cnVlfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fb25VcGRhdGUoXG4gICAgICB0aGlzLl9mcm9tVmFsdWUgK1xuICAgICAgICB0aGlzLl9lYXNpbmcoKG5vdyAtIHRoaXMuX3N0YXJ0VGltZSkgLyB0aGlzLl9kdXJhdGlvbikgKlxuICAgICAgICAgICh0aGlzLl90b1ZhbHVlIC0gdGhpcy5fZnJvbVZhbHVlKSxcbiAgICApO1xuICAgIGlmICh0aGlzLl9fYWN0aXZlKSB7XG4gICAgICB0aGlzLl9hbmltYXRpb25GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLm9uVXBkYXRlLmJpbmQodGhpcykpO1xuICAgIH1cbiAgfVxuXG4gIHN0b3AoKTogdm9pZCB7XG4gICAgc3VwZXIuc3RvcCgpO1xuICAgIHRoaXMuX19hY3RpdmUgPSBmYWxzZTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCk7XG4gICAgZ2xvYmFsLmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX2FuaW1hdGlvbkZyYW1lKTtcbiAgICB0aGlzLl9fZGVib3VuY2VkT25FbmQoe2ZpbmlzaGVkOiBmYWxzZX0pO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gVGltaW5nQW5pbWF0aW9uO1xuIl19