539e79c4948b3276ff0c4648e5d258cc
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var performanceNow = require('fbjs/lib/performanceNow');

var warning = require('fbjs/lib/warning');

var Info = function Info() {
  (0, _classCallCheck2["default"])(this, Info);
  this.any_blank_count = 0;
  this.any_blank_ms = 0;
  this.any_blank_speed_sum = 0;
  this.mostly_blank_count = 0;
  this.mostly_blank_ms = 0;
  this.pixels_blank = 0;
  this.pixels_sampled = 0;
  this.pixels_scrolled = 0;
  this.total_time_spent = 0;
  this.sample_count = 0;
};

var DEBUG = false;
var _listeners = [];
var _minSampleCount = 10;

var _sampleRate = DEBUG ? 1 : null;

var FillRateHelper = function () {
  (0, _createClass2["default"])(FillRateHelper, null, [{
    key: "addListener",
    value: function addListener(callback) {
      warning(_sampleRate !== null, 'Call `FillRateHelper.setSampleRate` before `addListener`.');

      _listeners.push(callback);

      return {
        remove: function remove() {
          _listeners = _listeners.filter(function (listener) {
            return callback !== listener;
          });
        }
      };
    }
  }, {
    key: "setSampleRate",
    value: function setSampleRate(sampleRate) {
      _sampleRate = sampleRate;
    }
  }, {
    key: "setMinSampleCount",
    value: function setMinSampleCount(minSampleCount) {
      _minSampleCount = minSampleCount;
    }
  }]);

  function FillRateHelper(getFrameMetrics) {
    (0, _classCallCheck2["default"])(this, FillRateHelper);
    this._anyBlankStartTime = null;
    this._enabled = false;
    this._getFrameMetrics = void 0;
    this._info = new Info();
    this._mostlyBlankStartTime = null;
    this._samplesStartTime = null;
    this._getFrameMetrics = getFrameMetrics;
    this._enabled = (_sampleRate || 0) > Math.random();

    this._resetData();
  }

  (0, _createClass2["default"])(FillRateHelper, [{
    key: "activate",
    value: function activate() {
      if (this._enabled && this._samplesStartTime == null) {
        DEBUG && console.debug('FillRateHelper: activate');
        this._samplesStartTime = performanceNow();
      }
    }
  }, {
    key: "deactivateAndFlush",
    value: function deactivateAndFlush() {
      if (!this._enabled) {
        return;
      }

      var start = this._samplesStartTime;

      if (start == null) {
        DEBUG && console.debug('FillRateHelper: bail on deactivate with no start time');
        return;
      }

      if (this._info.sample_count < _minSampleCount) {
        this._resetData();

        return;
      }

      var total_time_spent = performanceNow() - start;

      var info = _objectSpread({}, this._info, {
        total_time_spent: total_time_spent
      });

      if (DEBUG) {
        var derived = {
          avg_blankness: this._info.pixels_blank / this._info.pixels_sampled,
          avg_speed: this._info.pixels_scrolled / (total_time_spent / 1000),
          avg_speed_when_any_blank: this._info.any_blank_speed_sum / this._info.any_blank_count,
          any_blank_per_min: this._info.any_blank_count / (total_time_spent / 1000 / 60),
          any_blank_time_frac: this._info.any_blank_ms / total_time_spent,
          mostly_blank_per_min: this._info.mostly_blank_count / (total_time_spent / 1000 / 60),
          mostly_blank_time_frac: this._info.mostly_blank_ms / total_time_spent
        };

        for (var key in derived) {
          derived[key] = Math.round(1000 * derived[key]) / 1000;
        }

        console.debug('FillRateHelper deactivateAndFlush: ', {
          derived: derived,
          info: info
        });
      }

      _listeners.forEach(function (listener) {
        return listener(info);
      });

      this._resetData();
    }
  }, {
    key: "computeBlankness",
    value: function computeBlankness(props, state, scrollMetrics) {
      if (!this._enabled || props.getItemCount(props.data) === 0 || this._samplesStartTime == null) {
        return 0;
      }

      var dOffset = scrollMetrics.dOffset,
          offset = scrollMetrics.offset,
          velocity = scrollMetrics.velocity,
          visibleLength = scrollMetrics.visibleLength;
      this._info.sample_count++;
      this._info.pixels_sampled += Math.round(visibleLength);
      this._info.pixels_scrolled += Math.round(Math.abs(dOffset));
      var scrollSpeed = Math.round(Math.abs(velocity) * 1000);
      var now = performanceNow();

      if (this._anyBlankStartTime != null) {
        this._info.any_blank_ms += now - this._anyBlankStartTime;
      }

      this._anyBlankStartTime = null;

      if (this._mostlyBlankStartTime != null) {
        this._info.mostly_blank_ms += now - this._mostlyBlankStartTime;
      }

      this._mostlyBlankStartTime = null;
      var blankTop = 0;
      var first = state.first;

      var firstFrame = this._getFrameMetrics(first);

      while (first <= state.last && (!firstFrame || !firstFrame.inLayout)) {
        firstFrame = this._getFrameMetrics(first);
        first++;
      }

      if (firstFrame && first > 0) {
        blankTop = Math.min(visibleLength, Math.max(0, firstFrame.offset - offset));
      }

      var blankBottom = 0;
      var last = state.last;

      var lastFrame = this._getFrameMetrics(last);

      while (last >= state.first && (!lastFrame || !lastFrame.inLayout)) {
        lastFrame = this._getFrameMetrics(last);
        last--;
      }

      if (lastFrame && last < props.getItemCount(props.data) - 1) {
        var bottomEdge = lastFrame.offset + lastFrame.length;
        blankBottom = Math.min(visibleLength, Math.max(0, offset + visibleLength - bottomEdge));
      }

      var pixels_blank = Math.round(blankTop + blankBottom);
      var blankness = pixels_blank / visibleLength;

      if (blankness > 0) {
        this._anyBlankStartTime = now;
        this._info.any_blank_speed_sum += scrollSpeed;
        this._info.any_blank_count++;
        this._info.pixels_blank += pixels_blank;

        if (blankness > 0.5) {
          this._mostlyBlankStartTime = now;
          this._info.mostly_blank_count++;
        }
      } else if (scrollSpeed < 0.01 || Math.abs(dOffset) < 1) {
        this.deactivateAndFlush();
      }

      return blankness;
    }
  }, {
    key: "enabled",
    value: function enabled() {
      return this._enabled;
    }
  }, {
    key: "_resetData",
    value: function _resetData() {
      this._anyBlankStartTime = null;
      this._info = new Info();
      this._mostlyBlankStartTime = null;
      this._samplesStartTime = null;
    }
  }]);
  return FillRateHelper;
}();

module.exports = FillRateHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkZpbGxSYXRlSGVscGVyLmpzIl0sIm5hbWVzIjpbInBlcmZvcm1hbmNlTm93IiwicmVxdWlyZSIsIndhcm5pbmciLCJJbmZvIiwiYW55X2JsYW5rX2NvdW50IiwiYW55X2JsYW5rX21zIiwiYW55X2JsYW5rX3NwZWVkX3N1bSIsIm1vc3RseV9ibGFua19jb3VudCIsIm1vc3RseV9ibGFua19tcyIsInBpeGVsc19ibGFuayIsInBpeGVsc19zYW1wbGVkIiwicGl4ZWxzX3Njcm9sbGVkIiwidG90YWxfdGltZV9zcGVudCIsInNhbXBsZV9jb3VudCIsIkRFQlVHIiwiX2xpc3RlbmVycyIsIl9taW5TYW1wbGVDb3VudCIsIl9zYW1wbGVSYXRlIiwiRmlsbFJhdGVIZWxwZXIiLCJjYWxsYmFjayIsInB1c2giLCJyZW1vdmUiLCJmaWx0ZXIiLCJsaXN0ZW5lciIsInNhbXBsZVJhdGUiLCJtaW5TYW1wbGVDb3VudCIsImdldEZyYW1lTWV0cmljcyIsIl9hbnlCbGFua1N0YXJ0VGltZSIsIl9lbmFibGVkIiwiX2dldEZyYW1lTWV0cmljcyIsIl9pbmZvIiwiX21vc3RseUJsYW5rU3RhcnRUaW1lIiwiX3NhbXBsZXNTdGFydFRpbWUiLCJNYXRoIiwicmFuZG9tIiwiX3Jlc2V0RGF0YSIsImNvbnNvbGUiLCJkZWJ1ZyIsInN0YXJ0IiwiaW5mbyIsImRlcml2ZWQiLCJhdmdfYmxhbmtuZXNzIiwiYXZnX3NwZWVkIiwiYXZnX3NwZWVkX3doZW5fYW55X2JsYW5rIiwiYW55X2JsYW5rX3Blcl9taW4iLCJhbnlfYmxhbmtfdGltZV9mcmFjIiwibW9zdGx5X2JsYW5rX3Blcl9taW4iLCJtb3N0bHlfYmxhbmtfdGltZV9mcmFjIiwia2V5Iiwicm91bmQiLCJmb3JFYWNoIiwicHJvcHMiLCJzdGF0ZSIsInNjcm9sbE1ldHJpY3MiLCJnZXRJdGVtQ291bnQiLCJkYXRhIiwiZE9mZnNldCIsIm9mZnNldCIsInZlbG9jaXR5IiwidmlzaWJsZUxlbmd0aCIsImFicyIsInNjcm9sbFNwZWVkIiwibm93IiwiYmxhbmtUb3AiLCJmaXJzdCIsImZpcnN0RnJhbWUiLCJsYXN0IiwiaW5MYXlvdXQiLCJtaW4iLCJtYXgiLCJibGFua0JvdHRvbSIsImxhc3RGcmFtZSIsImJvdHRvbUVkZ2UiLCJsZW5ndGgiLCJibGFua25lc3MiLCJkZWFjdGl2YXRlQW5kRmx1c2giLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFVQTs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxjQUFjLEdBQUdDLE9BQU8sQ0FBQyx5QkFBRCxDQUE5Qjs7QUFDQSxJQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxrQkFBRCxDQUF2Qjs7SUFJTUUsSTs7T0FDSkMsZSxHQUEwQixDO09BQzFCQyxZLEdBQXVCLEM7T0FDdkJDLG1CLEdBQThCLEM7T0FDOUJDLGtCLEdBQTZCLEM7T0FDN0JDLGUsR0FBMEIsQztPQUMxQkMsWSxHQUF1QixDO09BQ3ZCQyxjLEdBQXlCLEM7T0FDekJDLGUsR0FBMEIsQztPQUMxQkMsZ0IsR0FBMkIsQztPQUMzQkMsWSxHQUF1QixDOzs7QUFLekIsSUFBTUMsS0FBSyxHQUFHLEtBQWQ7QUFFQSxJQUFJQyxVQUFpQyxHQUFHLEVBQXhDO0FBQ0EsSUFBSUMsZUFBZSxHQUFHLEVBQXRCOztBQUNBLElBQUlDLFdBQVcsR0FBR0gsS0FBSyxHQUFHLENBQUgsR0FBTyxJQUE5Qjs7SUFVTUksYzs7O2dDQVFlQyxRLEVBQXNEO0FBQ3ZFakIsTUFBQUEsT0FBTyxDQUNMZSxXQUFXLEtBQUssSUFEWCxFQUVMLDJEQUZLLENBQVA7O0FBSUFGLE1BQUFBLFVBQVUsQ0FBQ0ssSUFBWCxDQUFnQkQsUUFBaEI7O0FBQ0EsYUFBTztBQUNMRSxRQUFBQSxNQUFNLEVBQUUsa0JBQU07QUFDWk4sVUFBQUEsVUFBVSxHQUFHQSxVQUFVLENBQUNPLE1BQVgsQ0FBa0IsVUFBQUMsUUFBUTtBQUFBLG1CQUFJSixRQUFRLEtBQUtJLFFBQWpCO0FBQUEsV0FBMUIsQ0FBYjtBQUNEO0FBSEksT0FBUDtBQUtEOzs7a0NBRW9C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QUNEOztBQUNELGFBQU9ELFNBQVA7QUFDRDs7OzhCQUVrQjtBQUNqQixhQUFPLEtBQUs5QyxRQUFaO0FBQ0Q7OztpQ0FFWTtBQUNYLFdBQUtELGtCQUFMLEdBQTBCLElBQTFCO0FBQ0EsV0FBS0csS0FBTCxHQUFhLElBQUkzQixJQUFKLEVBQWI7QUFDQSxXQUFLNEIscUJBQUwsR0FBNkIsSUFBN0I7QUFDQSxXQUFLQyxpQkFBTCxHQUF5QixJQUF6QjtBQUNEOzs7OztBQUdINEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCM0QsY0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwZXJmb3JtYW5jZU5vdyA9IHJlcXVpcmUoJ2ZianMvbGliL3BlcmZvcm1hbmNlTm93Jyk7XG5jb25zdCB3YXJuaW5nID0gcmVxdWlyZSgnZmJqcy9saWIvd2FybmluZycpO1xuXG5leHBvcnQgdHlwZSBGaWxsUmF0ZUluZm8gPSBJbmZvO1xuXG5jbGFzcyBJbmZvIHtcbiAgYW55X2JsYW5rX2NvdW50OiBudW1iZXIgPSAwO1xuICBhbnlfYmxhbmtfbXM6IG51bWJlciA9IDA7XG4gIGFueV9ibGFua19zcGVlZF9zdW06IG51bWJlciA9IDA7XG4gIG1vc3RseV9ibGFua19jb3VudDogbnVtYmVyID0gMDtcbiAgbW9zdGx5X2JsYW5rX21zOiBudW1iZXIgPSAwO1xuICBwaXhlbHNfYmxhbms6IG51bWJlciA9IDA7XG4gIHBpeGVsc19zYW1wbGVkOiBudW1iZXIgPSAwO1xuICBwaXhlbHNfc2Nyb2xsZWQ6IG51bWJlciA9IDA7XG4gIHRvdGFsX3RpbWVfc3BlbnQ6IG51bWJlciA9IDA7XG4gIHNhbXBsZV9jb3VudDogbnVtYmVyID0gMDtcbn1cblxudHlwZSBGcmFtZU1ldHJpY3MgPSB7aW5MYXlvdXQ/OiBib29sZWFuLCBsZW5ndGg6IG51bWJlciwgb2Zmc2V0OiBudW1iZXJ9O1xuXG5jb25zdCBERUJVRyA9IGZhbHNlO1xuXG5sZXQgX2xpc3RlbmVyczogQXJyYXk8KEluZm8pID0+IHZvaWQ+ID0gW107XG5sZXQgX21pblNhbXBsZUNvdW50ID0gMTA7XG5sZXQgX3NhbXBsZVJhdGUgPSBERUJVRyA/IDEgOiBudWxsO1xuXG4vKipcbiAqIEEgaGVscGVyIGNsYXNzIGZvciBkZXRlY3Rpbmcgd2hlbiB0aGUgbWF4aW1lbSBmaWxsIHJhdGUgb2YgYFZpcnR1YWxpemVkTGlzdGAgaXMgZXhjZWVkZWQuXG4gKiBCeSBkZWZhdWx0IHRoZSBzYW1wbGluZyByYXRlIGlzIHNldCB0byB6ZXJvIGFuZCB0aGlzIHdpbGwgZG8gbm90aGluZy4gSWYgeW91IHdhbnQgdG8gY29sbGVjdFxuICogc2FtcGxlcyAoZS5nLiB0byBsb2cgdGhlbSksIG1ha2Ugc3VyZSB0byBjYWxsIGBGaWxsUmF0ZUhlbHBlci5zZXRTYW1wbGVSYXRlKDAuMC0xLjApYC5cbiAqXG4gKiBMaXN0ZW5lcnMgYW5kIHNhbXBsZSByYXRlIGFyZSBnbG9iYWwgZm9yIGFsbCBgVmlydHVhbGl6ZWRMaXN0YHMgLSB0eXBpY2FsIHVzYWdlIHdpbGwgY29tYmluZSB3aXRoXG4gKiBgU2NlbmVUcmFja2VyLmdldEFjdGl2ZVNjZW5lYCB0byBkZXRlcm1pbmUgdGhlIGNvbnRleHQgb2YgdGhlIGV2ZW50cy5cbiAqL1xuY2xhc3MgRmlsbFJhdGVIZWxwZXIge1xuICBfYW55QmxhbmtTdGFydFRpbWUgPSAobnVsbDogP251bWJlcik7XG4gIF9lbmFibGVkID0gZmFsc2U7XG4gIF9nZXRGcmFtZU1ldHJpY3M6IChpbmRleDogbnVtYmVyKSA9PiA/RnJhbWVNZXRyaWNzO1xuICBfaW5mbyA9IG5ldyBJbmZvKCk7XG4gIF9tb3N0bHlCbGFua1N0YXJ0VGltZSA9IChudWxsOiA/bnVtYmVyKTtcbiAgX3NhbXBsZXNTdGFydFRpbWUgPSAobnVsbDogP251bWJlcik7XG5cbiAgc3RhdGljIGFkZExpc3RlbmVyKGNhbGxiYWNrOiBGaWxsUmF0ZUluZm8gPT4gdm9pZCk6IHtyZW1vdmU6ICgpID0+IHZvaWR9IHtcbiAgICB3YXJuaW5nKFxuICAgICAgX3NhbXBsZVJhdGUgIT09IG51bGwsXG4gICAgICAnQ2FsbCBgRmlsbFJhdGVIZWxwZXIuc2V0U2FtcGxlUmF0ZWAgYmVmb3JlIGBhZGRMaXN0ZW5lcmAuJyxcbiAgICApO1xuICAgIF9saXN0ZW5lcnMucHVzaChjYWxsYmFjayk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHJlbW92ZTogKCkgPT4ge1xuICAgICAgICBfbGlzdGVuZXJzID0gX2xpc3RlbmVycy5maWx0ZXIobGlzdGVuZXIgPT4gY2FsbGJhY2sgIT09IGxpc3RlbmVyKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBzZXRTYW1wbGVSYXRlKHNhbXBsZVJhdGU6IG51bWJlcikge1xuICAgIF9zYW1wbGVSYXRlID0gc2FtcGxlUmF0ZTtcbiAgfVxuXG4gIHN0YXRpYyBzZXRNaW5TYW1wbGVDb3VudChtaW5TYW1wbGVDb3VudDogbnVtYmVyKSB7XG4gICAgX21pblNhbXBsZUNvdW50ID0gbWluU2FtcGxlQ291bnQ7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihnZXRGcmFtZU1ldHJpY3M6IChpbmRleDogbnVtYmVyKSA9PiA/RnJhbWVNZXRyaWNzKSB7XG4gICAgdGhpcy5fZ2V0RnJhbWVNZXRyaWNzID0gZ2V0RnJhbWVNZXRyaWNzO1xuICAgIHRoaXMuX2VuYWJsZWQgPSAoX3NhbXBsZVJhdGUgfHwgMCkgPiBNYXRoLnJhbmRvbSgpO1xuICAgIHRoaXMuX3Jlc2V0RGF0YSgpO1xuICB9XG5cbiAgYWN0aXZhdGUoKSB7XG4gICAgaWYgKHRoaXMuX2VuYWJsZWQgJiYgdGhpcy5fc2FtcGxlc1N0YXJ0VGltZSA9PSBudWxsKSB7XG4gICAgICBERUJVRyAmJiBjb25zb2xlLmRlYnVnKCdGaWxsUmF0ZUhlbHBlcjogYWN0aXZhdGUnKTtcbiAgICAgIHRoaXMuX3NhbXBsZXNTdGFydFRpbWUgPSBwZXJmb3JtYW5jZU5vdygpO1xuICAgIH1cbiAgfVxuXG4gIGRlYWN0aXZhdGVBbmRGbHVzaCgpIHtcbiAgICBpZiAoIXRoaXMuX2VuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLl9zYW1wbGVzU3RhcnRUaW1lOyAvLyBjb25zdCBmb3IgZmxvd1xuICAgIGlmIChzdGFydCA9PSBudWxsKSB7XG4gICAgICBERUJVRyAmJlxuICAgICAgICBjb25zb2xlLmRlYnVnKCdGaWxsUmF0ZUhlbHBlcjogYmFpbCBvbiBkZWFjdGl2YXRlIHdpdGggbm8gc3RhcnQgdGltZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5faW5mby5zYW1wbGVfY291bnQgPCBfbWluU2FtcGxlQ291bnQpIHtcbiAgICAgIC8vIERvbid0IGJvdGhlciB3aXRoIHVuZGVyLXNhbXBsZWQgZXZlbnRzLlxuICAgICAgdGhpcy5fcmVzZXREYXRhKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHRvdGFsX3RpbWVfc3BlbnQgPSBwZXJmb3JtYW5jZU5vdygpIC0gc3RhcnQ7XG4gICAgY29uc3QgaW5mbzogYW55ID0ge1xuICAgICAgLi4udGhpcy5faW5mbyxcbiAgICAgIHRvdGFsX3RpbWVfc3BlbnQsXG4gICAgfTtcbiAgICBpZiAoREVCVUcpIHtcbiAgICAgIGNvbnN0IGRlcml2ZWQgPSB7XG4gICAgICAgIGF2Z19ibGFua25lc3M6IHRoaXMuX2luZm8ucGl4ZWxzX2JsYW5rIC8gdGhpcy5faW5mby5waXhlbHNfc2FtcGxlZCxcbiAgICAgICAgYXZnX3NwZWVkOiB0aGlzLl9pbmZvLnBpeGVsc19zY3JvbGxlZCAvICh0b3RhbF90aW1lX3NwZW50IC8gMTAwMCksXG4gICAgICAgIGF2Z19zcGVlZF93aGVuX2FueV9ibGFuazpcbiAgICAgICAgICB0aGlzLl9pbmZvLmFueV9ibGFua19zcGVlZF9zdW0gLyB0aGlzLl9pbmZvLmFueV9ibGFua19jb3VudCxcbiAgICAgICAgYW55X2JsYW5rX3Blcl9taW46XG4gICAgICAgICAgdGhpcy5faW5mby5hbnlfYmxhbmtfY291bnQgLyAodG90YWxfdGltZV9zcGVudCAvIDEwMDAgLyA2MCksXG4gICAgICAgIGFueV9ibGFua190aW1lX2ZyYWM6IHRoaXMuX2luZm8uYW55X2JsYW5rX21zIC8gdG90YWxfdGltZV9zcGVudCxcbiAgICAgICAgbW9zdGx5X2JsYW5rX3Blcl9taW46XG4gICAgICAgICAgdGhpcy5faW5mby5tb3N0bHlfYmxhbmtfY291bnQgLyAodG90YWxfdGltZV9zcGVudCAvIDEwMDAgLyA2MCksXG4gICAgICAgIG1vc3RseV9ibGFua190aW1lX2ZyYWM6IHRoaXMuX2luZm8ubW9zdGx5X2JsYW5rX21zIC8gdG90YWxfdGltZV9zcGVudCxcbiAgICAgIH07XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBkZXJpdmVkKSB7XG4gICAgICAgIGRlcml2ZWRba2V5XSA9IE1hdGgucm91bmQoMTAwMCAqIGRlcml2ZWRba2V5XSkgLyAxMDAwO1xuICAgICAgfVxuICAgICAgY29uc29sZS5kZWJ1ZygnRmlsbFJhdGVIZWxwZXIgZGVhY3RpdmF0ZUFuZEZsdXNoOiAnLCB7ZGVyaXZlZCwgaW5mb30pO1xuICAgIH1cbiAgICBfbGlzdGVuZXJzLmZvckVhY2gobGlzdGVuZXIgPT4gbGlzdGVuZXIoaW5mbykpO1xuICAgIHRoaXMuX3Jlc2V0RGF0YSgpO1xuICB9XG5cbiAgY29tcHV0ZUJsYW5rbmVzcyhcbiAgICBwcm9wczoge1xuICAgICAgZGF0YTogQXJyYXk8YW55PixcbiAgICAgIGdldEl0ZW1Db3VudDogKGRhdGE6IEFycmF5PGFueT4pID0+IG51bWJlcixcbiAgICAgIGluaXRpYWxOdW1Ub1JlbmRlcjogbnVtYmVyLFxuICAgIH0sXG4gICAgc3RhdGU6IHtcbiAgICAgIGZpcnN0OiBudW1iZXIsXG4gICAgICBsYXN0OiBudW1iZXIsXG4gICAgfSxcbiAgICBzY3JvbGxNZXRyaWNzOiB7XG4gICAgICBkT2Zmc2V0OiBudW1iZXIsXG4gICAgICBvZmZzZXQ6IG51bWJlcixcbiAgICAgIHZlbG9jaXR5OiBudW1iZXIsXG4gICAgICB2aXNpYmxlTGVuZ3RoOiBudW1iZXIsXG4gICAgfSxcbiAgKTogbnVtYmVyIHtcbiAgICBpZiAoXG4gICAgICAhdGhpcy5fZW5hYmxlZCB8fFxuICAgICAgcHJvcHMuZ2V0SXRlbUNvdW50KHByb3BzLmRhdGEpID09PSAwIHx8XG4gICAgICB0aGlzLl9zYW1wbGVzU3RhcnRUaW1lID09IG51bGxcbiAgICApIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgICBjb25zdCB7ZE9mZnNldCwgb2Zmc2V0LCB2ZWxvY2l0eSwgdmlzaWJsZUxlbmd0aH0gPSBzY3JvbGxNZXRyaWNzO1xuXG4gICAgLy8gRGVub21pbmF0b3IgbWV0cmljcyB0aGF0IHdlIHRyYWNrIGZvciBhbGwgZXZlbnRzIC0gbW9zdCBvZiB0aGUgdGltZSB0aGVyZSBpcyBubyBibGFua25lc3MgYW5kXG4gICAgLy8gd2Ugd2FudCB0byBjYXB0dXJlIHRoYXQuXG4gICAgdGhpcy5faW5mby5zYW1wbGVfY291bnQrKztcbiAgICB0aGlzLl9pbmZvLnBpeGVsc19zYW1wbGVkICs9IE1hdGgucm91bmQodmlzaWJsZUxlbmd0aCk7XG4gICAgdGhpcy5faW5mby5waXhlbHNfc2Nyb2xsZWQgKz0gTWF0aC5yb3VuZChNYXRoLmFicyhkT2Zmc2V0KSk7XG4gICAgY29uc3Qgc2Nyb2xsU3BlZWQgPSBNYXRoLnJvdW5kKE1hdGguYWJzKHZlbG9jaXR5KSAqIDEwMDApOyAvLyBweCAvIHNlY1xuXG4gICAgLy8gV2hldGhlciBibGFuayBub3cgb3Igbm90LCByZWNvcmQgdGhlIGVsYXBzZWQgdGltZSBibGFuayBpZiB3ZSB3ZXJlIGJsYW5rIGxhc3QgdGltZS5cbiAgICBjb25zdCBub3cgPSBwZXJmb3JtYW5jZU5vdygpO1xuICAgIGlmICh0aGlzLl9hbnlCbGFua1N0YXJ0VGltZSAhPSBudWxsKSB7XG4gICAgICB0aGlzLl9pbmZvLmFueV9ibGFua19tcyArPSBub3cgLSB0aGlzLl9hbnlCbGFua1N0YXJ0VGltZTtcbiAgICB9XG4gICAgdGhpcy5fYW55QmxhbmtTdGFydFRpbWUgPSBudWxsO1xuICAgIGlmICh0aGlzLl9tb3N0bHlCbGFua1N0YXJ0VGltZSAhPSBudWxsKSB7XG4gICAgICB0aGlzLl9pbmZvLm1vc3RseV9ibGFua19tcyArPSBub3cgLSB0aGlzLl9tb3N0bHlCbGFua1N0YXJ0VGltZTtcbiAgICB9XG4gICAgdGhpcy5fbW9zdGx5QmxhbmtTdGFydFRpbWUgPSBudWxsO1xuXG4gICAgbGV0IGJsYW5rVG9wID0gMDtcbiAgICBsZXQgZmlyc3QgPSBzdGF0ZS5maXJzdDtcbiAgICBsZXQgZmlyc3RGcmFtZSA9IHRoaXMuX2dldEZyYW1lTWV0cmljcyhmaXJzdCk7XG4gICAgd2hpbGUgKGZpcnN0IDw9IHN0YXRlLmxhc3QgJiYgKCFmaXJzdEZyYW1lIHx8ICFmaXJzdEZyYW1lLmluTGF5b3V0KSkge1xuICAgICAgZmlyc3RGcmFtZSA9IHRoaXMuX2dldEZyYW1lTWV0cmljcyhmaXJzdCk7XG4gICAgICBmaXJzdCsrO1xuICAgIH1cbiAgICAvLyBPbmx5IGNvdW50IGJsYW5rVG9wIGlmIHdlIGFyZW4ndCByZW5kZXJpbmcgdGhlIGZpcnN0IGl0ZW0sIG90aGVyd2lzZSB3ZSB3aWxsIGNvdW50IHRoZSBoZWFkZXJcbiAgICAvLyBhcyBibGFuay5cbiAgICBpZiAoZmlyc3RGcmFtZSAmJiBmaXJzdCA+IDApIHtcbiAgICAgIGJsYW5rVG9wID0gTWF0aC5taW4oXG4gICAgICAgIHZpc2libGVMZW5ndGgsXG4gICAgICAgIE1hdGgubWF4KDAsIGZpcnN0RnJhbWUub2Zmc2V0IC0gb2Zmc2V0KSxcbiAgICAgICk7XG4gICAgfVxuICAgIGxldCBibGFua0JvdHRvbSA9IDA7XG4gICAgbGV0IGxhc3QgPSBzdGF0ZS5sYXN0O1xuICAgIGxldCBsYXN0RnJhbWUgPSB0aGlzLl9nZXRGcmFtZU1ldHJpY3MobGFzdCk7XG4gICAgd2hpbGUgKGxhc3QgPj0gc3RhdGUuZmlyc3QgJiYgKCFsYXN0RnJhbWUgfHwgIWxhc3RGcmFtZS5pbkxheW91dCkpIHtcbiAgICAgIGxhc3RGcmFtZSA9IHRoaXMuX2dldEZyYW1lTWV0cmljcyhsYXN0KTtcbiAgICAgIGxhc3QtLTtcbiAgICB9XG4gICAgLy8gT25seSBjb3VudCBibGFua0JvdHRvbSBpZiB3ZSBhcmVuJ3QgcmVuZGVyaW5nIHRoZSBsYXN0IGl0ZW0sIG90aGVyd2lzZSB3ZSB3aWxsIGNvdW50IHRoZVxuICAgIC8vIGZvb3RlciBhcyBibGFuay5cbiAgICBpZiAobGFzdEZyYW1lICYmIGxhc3QgPCBwcm9wcy5nZXRJdGVtQ291bnQocHJvcHMuZGF0YSkgLSAxKSB7XG4gICAgICBjb25zdCBib3R0b21FZGdlID0gbGFzdEZyYW1lLm9mZnNldCArIGxhc3RGcmFtZS5sZW5ndGg7XG4gICAgICBibGFua0JvdHRvbSA9IE1hdGgubWluKFxuICAgICAgICB2aXNpYmxlTGVuZ3RoLFxuICAgICAgICBNYXRoLm1heCgwLCBvZmZzZXQgKyB2aXNpYmxlTGVuZ3RoIC0gYm90dG9tRWRnZSksXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBwaXhlbHNfYmxhbmsgPSBNYXRoLnJvdW5kKGJsYW5rVG9wICsgYmxhbmtCb3R0b20pO1xuICAgIGNvbnN0IGJsYW5rbmVzcyA9IHBpeGVsc19ibGFuayAvIHZpc2libGVMZW5ndGg7XG4gICAgaWYgKGJsYW5rbmVzcyA+IDApIHtcbiAgICAgIHRoaXMuX2FueUJsYW5rU3RhcnRUaW1lID0gbm93O1xuICAgICAgdGhpcy5faW5mby5hbnlfYmxhbmtfc3BlZWRfc3VtICs9IHNjcm9sbFNwZWVkO1xuICAgICAgdGhpcy5faW5mby5hbnlfYmxhbmtfY291bnQrKztcbiAgICAgIHRoaXMuX2luZm8ucGl4ZWxzX2JsYW5rICs9IHBpeGVsc19ibGFuaztcbiAgICAgIGlmIChibGFua25lc3MgPiAwLjUpIHtcbiAgICAgICAgdGhpcy5fbW9zdGx5QmxhbmtTdGFydFRpbWUgPSBub3c7XG4gICAgICAgIHRoaXMuX2luZm8ubW9zdGx5X2JsYW5rX2NvdW50Kys7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChzY3JvbGxTcGVlZCA8IDAuMDEgfHwgTWF0aC5hYnMoZE9mZnNldCkgPCAxKSB7XG4gICAgICB0aGlzLmRlYWN0aXZhdGVBbmRGbHVzaCgpO1xuICAgIH1cbiAgICByZXR1cm4gYmxhbmtuZXNzO1xuICB9XG5cbiAgZW5hYmxlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fZW5hYmxlZDtcbiAgfVxuXG4gIF9yZXNldERhdGEoKSB7XG4gICAgdGhpcy5fYW55QmxhbmtTdGFydFRpbWUgPSBudWxsO1xuICAgIHRoaXMuX2luZm8gPSBuZXcgSW5mbygpO1xuICAgIHRoaXMuX21vc3RseUJsYW5rU3RhcnRUaW1lID0gbnVsbDtcbiAgICB0aGlzLl9zYW1wbGVzU3RhcnRUaW1lID0gbnVsbDtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEZpbGxSYXRlSGVscGVyO1xuIl19